<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ryanair Flight Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
<header class="hero py-5">
  <div class="container text-center">
    <h1 class="display-5 fw-bold mb-2"><i class="bi bi-airplane-engines"></i> Ryanair Flight Finder</h1>
    <p class="lead text-muted mb-0">ez </p>
  </div>
</header>

<main class="container my-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-lg border-0 rounded-4">
        <div class="card-body p-4 p-md-5">
          <form method="post" class="row g-4">
            <!-- Departure airports: filter + click-to-add + chips -->
            <div class="col-md-6">
              <label class="form-label fw-semibold"><i class="bi bi-send"></i> Departure airport(s)</label>
              <input type="text" id="dep_filter" class="form-control form-control-lg mb-2" placeholder="Type to search… then click or press Enter to add">
              <select class="form-select fancy" name="departures" id="departures" multiple size="8" required>
                {% for code, label in airports %}
                  <option value="{{ code }}"
                    {% if form and code in form.getlist('departures') %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
              <div class="chips mt-2" id="dep_chips"></div>
              <div class="form-text">No Ctrl needed. Click to add/remove. Search box filters the list; Enter adds first match.</div>
            </div>

            <!-- Arrival: airport OR countries -->
            <div class="col-md-6">
              <label class="form-label fw-semibold"><i class="bi bi-geo-alt"></i> Arrival airport</label>
              <select class="form-select fancy" id="arrival" name="arrival">
                <option value="" {% if form and not form.get('arrival') %}selected{% endif %}>— none —</option>
                {% for code, label in airports %}
                  <option value="{{ code }}" {% if form and form.get('arrival') == code %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>

              <div class="mt-3">
                <label class="form-label fw-semibold"><i class="bi bi-flag"></i> Destination country/countries</label>
                <select class="form-select fancy" id="arrival_countries" name="arrival_countries" multiple size="6">
                  {% for cc, name in countries %}
                    <option value="{{ cc }}" {% if form and cc in form.getlist('arrival_countries') %}selected{% endif %}>
                      {{ name }} ({{ cc }})
                    </option>
                  {% endfor %}
                </select>
                <div class="form-text">If any country is selected, the Arrival airport field becomes disabled.</div>
              </div>
            </div>

            <!-- Dates -->
            <div class="col-md-6">
              <label class="form-label fw-semibold"><i class="bi bi-calendar-event"></i> Departure from</label>
              <input type="date" class="form-control form-control-lg" name="date_from"
                     value="{{ form.get('date_from') if form else today }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold"><i class="bi bi-calendar2-event"></i> Departure to</label>
              <input type="date" class="form-control form-control-lg" name="date_to"
                     value="{{ form.get('date_to') if form else '' }}" required>
            </div>

            <!-- Departure weekday -->
            <div class="col-md-6">
              <label class="form-label fw-semibold"><i class="bi bi-calendar-week"></i> Departure weekday</label>
              <select class="form-select form-select-lg" name="out_weekday">
                <option value="" {% if not form or not form.get('out_weekday') %}selected{% endif %}>Any day</option>
                <option value="0" {% if form and form.get('out_weekday')=='0' %}selected{% endif %}>Monday</option>
                <option value="1" {% if form and form.get('out_weekday')=='1' %}selected{% endif %}>Tuesday</option>
                <option value="2" {% if form and form.get('out_weekday')=='2' %}selected{% endif %}>Wednesday</option>
                <option value="3" {% if form and form.get('out_weekday')=='3' %}selected{% endif %}>Thursday</option>
                <option value="4" {% if form and form.get('out_weekday')=='4' %}selected{% endif %}>Friday</option>
                <option value="5" {% if form and form.get('out_weekday')=='5' %}selected{% endif %}>Saturday</option>
                <option value="6" {% if form and form.get('out_weekday')=='6' %}selected{% endif %}>Sunday</option>
              </select>
            </div>

            <!-- Stay window (disabled for one-way) -->
            <div class="col-md-3">
              <label class="form-label fw-semibold"><i class="bi bi-hourglass-split"></i> Stay from (days)</label>
              <input type="number" min="1" class="form-control form-control-lg" id="min_stay" name="min_stay"
                     value="{{ form.get('min_stay') if form else '4' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold"><i class="bi bi-hourglass-top"></i> Stay to (days)</label>
              <input type="number" min="1" class="form-control form-control-lg" id="max_stay" name="max_stay"
                     value="{{ form.get('max_stay') if form else '12' }}">
            </div>

            <!-- Currency + one-way -->
            <div class="col-md-4">
              <label class="form-label fw-semibold"><i class="bi bi-cash-coin"></i> Currency</label>
              <select class="form-select form-select-lg" name="currency">
                <option value="">Default (EUR)</option>
                <option value="EUR" {% if form and form.get('currency') == 'EUR' %}selected{% endif %}>Euro (EUR)</option>
                <option value="PLN" {% if form and form.get('currency') == 'PLN' %}selected{% endif %}>Polish Złoty (PLN)</option>
                <option value="GBP" {% if form and form.get('currency') == 'GBP' %}selected{% endif %}>Pound (GBP)</option>
              </select>
            </div>
            <div class="col-md-4 d-flex align-items-center">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="one_way_only" name="one_way_only"
                       {% if form and form.get('one_way_only') %}checked{% endif %}>
                <label class="form-check-label" for="one_way_only">One-way only</label>
              </div>
            </div>
            <div class="col-md-4 text-md-end">
              <button class="btn btn-primary btn-lg px-4 shadow-sm">
                <i class="bi bi-search"></i> Search flights
              </button>
            </div>

            {% if errors %}
              <div class="col-12">
                <div class="alert alert-danger mb-0">
                  <ul class="mb-0">{% for e in errors %}<li>{{ e }}</li>{% endfor %}</ul>
                </div>
              </div>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="py-4 text-center text-muted small">
  Made by MAK0
</footer>

<script>
  // One-way toggles stay inputs
  const oneWay = document.getElementById('one_way_only');
  const minStay = document.getElementById('min_stay');
  const maxStay = document.getElementById('max_stay');
  function toggleStay(){ const dis = oneWay.checked; minStay.disabled = dis; maxStay.disabled = dis; }
  if(oneWay){ oneWay.addEventListener('change', toggleStay); toggleStay(); }

  // Disable Arrival airport when any country selected
  const arrivalSel = document.getElementById('arrival');
  const countriesSel = document.getElementById('arrival_countries');
  function toggleArrival(){
    const anyCountry = [...countriesSel.options].some(o => o.selected);
    arrivalSel.disabled = anyCountry;
    if(anyCountry){ arrivalSel.value = ""; }
  }
  countriesSel.addEventListener('change', toggleArrival); toggleArrival();

  // ========== Departure multi-pick UX: filter + click-to-toggle + chips + Enter to add first match ==========
  const depSel = document.getElementById('departures');
  const depFilter = document.getElementById('dep_filter');
  const depChips = document.getElementById('dep_chips');

  function updateChips(){
    depChips.innerHTML = '';
    [...depSel.options].forEach(opt=>{
      if(opt.selected){
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = opt.text;
        const x = document.createElement('button');
        x.type='button'; x.className='chip-x'; x.innerHTML='&times;';
        x.onclick = ()=>{ opt.selected=false; updateChips(); };
        chip.appendChild(x);
        depChips.appendChild(chip);
      }
    });
  }

  // Toggle selection on click (no Ctrl)
  depSel.addEventListener('mousedown', (e)=>{
    e.preventDefault();
    const opt = e.target;
    if(opt.tagName==='OPTION'){
      opt.selected = !opt.selected;
      updateChips();
    }
  });

  // Filter options while typing
  function applyFilter(){
    const q = depFilter.value.trim().toLowerCase();
    [...depSel.options].forEach(opt=>{
      const text = opt.text.toLowerCase();
      const val = opt.value.toLowerCase();
      opt.hidden = !(text.includes(q) || val.includes(q));
    });
  }
  depFilter.addEventListener('input', applyFilter);

  // Enter adds first visible option
  depFilter.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      const first = [...depSel.options].find(o => !o.hidden);
      if(first){
        first.selected = true;
        updateChips();
        depFilter.value = '';
        applyFilter();
      }
    }
  });

  // Init
  applyFilter();
  updateChips();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
